<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>帳號管理 (管理者)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div id="topNavbar"></div>

  <main class="container py-4">
    <h2>平台管理者帳號管理</h2>

    <div id="adminAlert"></div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">新增管理者帳號</h5>
        <div class="row g-2">
          <div class="col-md-4"><input id="newUsername" class="form-control" placeholder="username"></div>
          <div class="col-md-4"><input id="newDisplayName" class="form-control" placeholder="顯示名稱"></div>
          <div class="col-md-4"><input id="newPassword" type="password" class="form-control" placeholder="password"></div>
        </div>
        <div class="mt-2">
          <button id="btnCreateAdmin" class="btn btn-primary">建立</button>
        </div>
      </div>
    </div>

    <h5>現有管理者</h5>
    <div id="adminList" class="list-group">載入中...</div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/navbar.js"></script>

  <script>
    (function(){
      async function loadAdmins(){
        try {
          const res = await apiGet('/api/admins.php?action=list');
          if (!res.success) throw new Error(res.message || '取得失敗');
          const data = res.data || [];
          const container = document.getElementById('adminList');
          if (data.length === 0) container.innerHTML = '<div class="text-muted">尚無管理者</div>';
          else {
            container.innerHTML = '';
            data.forEach(a => {
              const div = document.createElement('div');
              div.className = 'list-group-item d-flex justify-content-between align-items-center';
              div.innerHTML = `<div>
                                <strong>${escapeHtml(a.username)}</strong><br/>
                                <small>${escapeHtml(a.display_name || '')} • ${a.created_at}</small>
                              </div>
                              <div>
                                <button class="btn btn-sm btn-danger btn-delete" data-id="${a.id}">刪除</button>
                              </div>`;
              container.appendChild(div);
            });
            document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', onDelete));
          }
        } catch (err) {
          showAlert('adminAlert','danger', err.message);
        }
      }

      async function onDelete(e){
        if (!confirm('確定刪除此管理者？')) return;
        const id = e.currentTarget.dataset.id;
        try {
          const res = await apiPost('/api/admins.php?action=delete', { id });
          if (res.success) {
            showAlert('adminAlert','success', res.message || '刪除成功');
            loadAdmins();
          } else showAlert('adminAlert','danger', res.message || '刪除失敗');
        } catch (err) {
          showAlert('adminAlert','danger', err.message);
        }
      }

      document.getElementById('btnCreateAdmin').addEventListener('click', async () => {
        const username = document.getElementById('newUsername').value.trim();
        const display_name = document.getElementById('newDisplayName').value.trim();
        const password = document.getElementById('newPassword').value;
        if (!username || !password) return showAlert('adminAlert','warning','請輸入帳號與密碼');
        try {
          const res = await apiPost('/api/admins.php?action=create', { username, display_name, password });
          if (res.success) {
            showAlert('adminAlert','success', res.message || '建立成功');
            document.getElementById('newUsername').value = '';
            document.getElementById('newDisplayName').value = '';
            document.getElementById('newPassword').value = '';
            loadAdmins();
          } else showAlert('adminAlert','danger', res.message || '建立失敗');
        } catch (err) {
          showAlert('adminAlert','danger', err.message);
        }
      });

      loadAdmins();
    })();
  </script>
</body>
</html>